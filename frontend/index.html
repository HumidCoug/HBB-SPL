
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BBANG Token Minter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #512da8;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    label, input, select, button {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      padding: 0.5rem;
    }
    .status {
      margin-top: 1rem;
      color: green;
    }
    .section-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 1.5rem 0 1rem;
    }
    #drop-zone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      color: #666;
      margin-bottom: 1rem;
    }
    #preview {
      display: none;
      max-width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>BBANG Token Minter</h1>
  </header>

  <div class="container">
    <button id="connect-button">Phantom ì§€ê°‘ ì—°ê²°</button>
    <p id="wallet-address"></p>

    <form id="mintForm">
      <label>Token Name</label>
      <input type="text" id="name" required />

      <label>Token Symbol</label>
      <input type="text" id="symbol" required />

      <label>Token Amount</label>
      <input type="number" id="amount" required />

      <div id="drop-zone">ğŸ‘‰ ì—¬ê¸°ë¡œ ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ìœ„ì—ì„œ ì„ íƒí•˜ì„¸ìš”.</div>
      <img id="preview" />

      <label>Token Image</label>
      <input type="file" id="image" accept="image/*" required />

      <button type="submit">í† í° ë°œí–‰í•˜ê¸° (0.04 ~ 0.05 SOL)</button>
    </form>

    <div class="section-title">ê¶Œí•œì´ ìˆëŠ” í† í° ëª©ë¡</div>
    <select id="ownedTokens"></select>

    <button id="mintMore">ì„ íƒ í† í° ì¶”ê°€ ë°œí–‰ (0.004 ~ 0.005 SOL)</button>
    <button id="revoke">ì„ íƒ í† í° ë¯¼íŒ… ê¶Œí•œ ì œê±° (0.004 ~ 0.005 SOL)</button>

    <div class="status" id="status"></div>
  </div>

  <script>
    const form = document.getElementById("mintForm");
    const ownedTokens = document.getElementById("ownedTokens");
    const mintMoreBtn = document.getElementById("mintMore");
    const revokeBtn = document.getElementById("revoke");
    const status = document.getElementById("status");
    const connectBtn = document.getElementById("connect-button");
    const walletAddr = document.getElementById("wallet-address");

    let Transaction; 

window.addEventListener("load", async () => {
  if (window.solana && window.solana.isPhantom) {
    Transaction = window.solanaWeb3.Transaction; 
    try {
      const resp = await window.solana.connect({ onlyIfTrusted: true });
      userAddress = resp.publicKey.toString();
      walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress;
      await fetchOwnedTokens(userAddress);
    } catch (err) {
      console.log("ìë™ ì—°ê²° ì‹¤íŒ¨:", err.message);
    }
  }
});


    connectBtn.onclick = async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          const alreadyConnected = userAddress !== null;
          if (!alreadyConnected) {
            const resp = await window.solana.connect();
            userAddress = resp.publicKey.toString();
            walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress;
            await fetchOwnedTokens(userAddress);

            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
            const balance = await connection.getBalance(new solanaWeb3.PublicKey(userAddress));
            if (balance < 0.05 * 1e9) {
              alert("SOL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 0.05 SOLì´ í•„ìš”í•©ë‹ˆë‹¤.");
              return;
            }
          } else {
            walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress + " (ì´ë¯¸ ì—°ê²°ë¨)";
          }
        } catch (err) {
          walletAddr.innerText = "ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: " + err.message;
        }
      } else {
        alert("Phantom ì§€ê°‘ì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.");
      }
    };

    async function fetchOwnedTokens(pubkey) {
      const res = await fetch(`/owned-tokens?wallet=${pubkey}`);
      if (!res.ok) {
        console.error("í† í° ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", res.statusText);
        return;
      }
      const tokens = await res.json();
      ownedTokens.innerHTML = "";
      if (tokens.length === 0) {
        ownedTokens.innerHTML = '<option disabled selected>ë¯¼íŒ… ê¶Œí•œ í† í° ì—†ìŒ</option>';
      } else {
        tokens.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          ownedTokens.appendChild(opt);
        });
      }
    }

    form.onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const symbol = document.getElementById("symbol").value;
  const amount = document.getElementById("amount").value;
  const imageFile = document.getElementById("image").files[0];

  const formData = new FormData();
  formData.append("name", name);
  formData.append("symbol", symbol);
  formData.append("amount", amount);
  formData.append("image", imageFile);
  formData.append("user", userAddress);

  try {
    const res = await fetch("/mint", {
      method: "POST",
      body: formData,
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
    }

    const result = await res.json();

    if (result.tx) {
      const txBuffer = Uint8Array.from(atob(result.tx), c => c.charCodeAt(0));
      const tx = Transaction.from(txBuffer);
      const signed = await window.solana.signAndSendTransaction(tx);
      status.innerText = "íŠ¸ëœì­ì…˜ ì„œëª… ì™„ë£Œ: " + signed.signature;
    } else {
      status.innerText = result.message || "íŠ¸ëœì­ì…˜ ìƒì„± ì‹¤íŒ¨";
    }
  } catch (err) {
    status.innerText = "ğŸš« ì˜¤ë¥˜ ë°œìƒ: " + err.message;
  }
};


    mintMoreBtn.onclick = async () => {
      const selected = ownedTokens.value;
      const amount = prompt("ì¶”ê°€ ë°œí–‰ ìˆ˜ëŸ‰ì€?");
      const res = await fetch("/mint-more", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mint: selected, amount }),
      });
      const result = await res.json();
      status.innerText = result.message || "ì¶”ê°€ ë°œí–‰ ì™„ë£Œ";
    };

    revokeBtn.onclick = async () => {
      const selected = ownedTokens.value;
      const confirmRevoke = confirm("ì •ë§ë¡œ ë¯¼íŒ… ê¶Œí•œì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      if (!confirmRevoke) return;

      const res = await fetch("/revoke", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mint: selected }),
      });
      const result = await res.json();
      status.innerText = result.message || "ë¯¼íŒ… ê¶Œí•œ ì œê±° ì™„ë£Œ";
    };
  </script>

  <script>
    const dropZone = document.getElementById("drop-zone");
    const imageInput = document.getElementById("image");

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.style.backgroundColor = "#eee";
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.style.backgroundColor = "transparent";
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.style.backgroundColor = "transparent";
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        imageInput.files = files;
        const reader = new FileReader();
        reader.onload = () => {
          const preview = document.getElementById("preview");
          preview.src = reader.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(files[0]);
      }
    });
    imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) {
    const allowedTypes = ["image/png", "image/jpeg", "image/webp"];
    if (!allowedTypes.includes(file.type)) {
      alert("âŒ ì´ ì´ë¯¸ì§€ í˜•ì‹ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní—ˆìš©ëœ í˜•ì‹: PNG, JPG, WEBP");
      imageInput.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById("preview").style.display = "none"; // ë¯¸ë¦¬ë³´ê¸°ë„ ìˆ¨ê¹€
    }
  }
});

  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.3/lib/index.iife.min.js"></script>
</body>
</html>
