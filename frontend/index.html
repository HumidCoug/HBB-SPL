<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BBANG Token Minter</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: url('3.png') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 220px 0 60px;
      box-sizing: border-box;
      position: relative;
      z-index: 0;
    }
    body::after {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('3.png') no-repeat center center fixed;
      background-size: cover;
      filter: contrast(150%) brightness(90%);
      mix-blend-mode: multiply;
      opacity: 0.3;
      pointer-events: none;
      z-index: -1;
    }
    .wrapper {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: stretch;
      max-width: 1600px;
      width: 98vw;
      gap: 80px;
      flex-wrap: nowrap;
      height: 100%;
    }
    .panel {
      flex: 1 1 400px;
      min-width: 400px;
      max-width: 700px;
      background: rgba(255, 255, 255, 0.15);
      background-image: url('noise_2.png'), url('noise_2.png');
      background-size: 100px;
      background-repeat: repeat;
      background-blend-mode: overlay;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 25px;
      box-shadow: 12.5px 12.5px 20px 5px rgba(0, 0, 0, 0.275);
      padding: 30px;
      box-sizing: border-box;
      min-height: 75vh;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    .panel:hover {
      box-shadow: 5px 10px 20px 5px rgba(0, 0, 0, 0.4);
      transform: translateY(-5px);
    }
    @media (max-width: 768px) {
      .wrapper {
        flex-direction: column;
        align-items: stretch;
        height: auto;
        padding: 80px 20px 20px;
      }
      .panel {
        min-height: 650px;
        margin-bottom: 60px;
      }
    }
    input, button, select, label {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
    }
    #drop-zone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      color: #666;
      margin-bottom: 1rem;
    }
    #preview {
      display: none;
      max-width: 100%;
      margin-top: 1rem;
    }
    .status {
      margin-top: 1rem;
      color: green;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="panel">
      <button id="connect-button">Phantom ì§€ê°‘ ì—°ê²°</button>
      <p id="wallet-address"></p>

      <form id="mintForm">
        <label>Token Name</label>
        <input type="text" id="name" required />

        <label>Token Symbol</label>
        <input type="text" id="symbol" required />

        <label>Token Amount</label>
        <input type="number" id="amount" required />

        <div id="drop-zone">ğŸ‘‰ ì—¬ê¸°ë¡œ ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ìœ„ì—ì„œ ì„ íƒí•˜ì„¸ìš”.</div>
        <img id="preview" />

        <label>Token Image</label>
        <input type="file" id="image" accept="image/*" required />

        <button type="submit">í† í° ë°œí–‰í•˜ê¸° (0.04 ~ 0.05 SOL)</button>
      </form>
    </div>

    <div class="panel">
      <div class="section-title">ê¶Œí•œì´ ìˆëŠ” í† í° ëª©ë¡</div>
      <select id="ownedTokens"></select>

      <button id="mintMore">ì„ íƒ í† í° ì¶”ê°€ ë°œí–‰ (0.004 ~ 0.005 SOL)</button>
      <button id="revoke">ì„ íƒ í† í° ë¯¼íŒ… ê¶Œí•œ ì œê±° (0.004 ~ 0.005 SOL)</button>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.3/lib/index.iife.min.js"></script>
  <script src="script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.3/lib/index.iife.min.js"></script>
<script>
  const form = document.getElementById("mintForm");
  const ownedTokens = document.getElementById("ownedTokens");
  const mintMoreBtn = document.getElementById("mintMore");
  const revokeBtn = document.getElementById("revoke");
  const status = document.getElementById("status");
  const connectBtn = document.getElementById("connect-button");
  const walletAddr = document.getElementById("wallet-address");
  const dropZone = document.getElementById("drop-zone");
  const imageInput = document.getElementById("image");
  let userAddress = null;
  let Transaction;

  window.addEventListener("load", async () => {
    if (window.solana && window.solana.isPhantom) {
      Transaction = window.solanaWeb3.Transaction;
      try {
        const resp = await window.solana.connect({ onlyIfTrusted: true });
        userAddress = resp.publicKey.toString();
        walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress;
        await fetchOwnedTokens(userAddress);
      } catch (err) {
        console.log("ìë™ ì—°ê²° ì‹¤íŒ¨:", err.message);
      }
    }
  });

  connectBtn.onclick = async () => {
    if (window.solana && window.solana.isPhantom) {
      try {
        if (!userAddress) {
          const resp = await window.solana.connect();
          userAddress = resp.publicKey.toString();
          walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress;
          await fetchOwnedTokens(userAddress);

          const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
          const balance = await connection.getBalance(new solanaWeb3.PublicKey(userAddress));
          if (balance < 0.05 * 1e9) {
            alert("SOL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 0.05 SOLì´ í•„ìš”í•©ë‹ˆë‹¤.");
          }
        } else {
          walletAddr.innerText = "ì§€ê°‘ ì£¼ì†Œ: " + userAddress + " (ì´ë¯¸ ì—°ê²°ë¨)";
        }
      } catch (err) {
        walletAddr.innerText = "ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: " + err.message;
      }
    } else {
      alert("Phantom ì§€ê°‘ì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.");
    }
  };

  async function fetchOwnedTokens(pubkey) {
    const res = await fetch(`https://hbb-spl.onrender.com/owned-tokens?wallet=${pubkey}`);
    if (!res.ok) {
      console.error("í† í° ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", res.statusText);
      return;
    }
    const tokens = await res.json();
    ownedTokens.innerHTML = "";
    if (tokens.length === 0) {
      ownedTokens.innerHTML = '<option disabled selected>ë¯¼íŒ… ê¶Œí•œ í† í° ì—†ìŒ</option>';
    } else {
      tokens.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        ownedTokens.appendChild(opt);
      });
    }
  }

  form.onsubmit = async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const symbol = document.getElementById("symbol").value;
    const amount = document.getElementById("amount").value;
    const imageFile = document.getElementById("image").files[0];

    const formData = new FormData();
    formData.append("name", name);
    formData.append("symbol", symbol);
    formData.append("amount", amount);
    formData.append("image", imageFile);
    formData.append("user", userAddress);

    try {
      const res = await fetch("https://hbb-spl.onrender.com/mint", {
        method: "POST",
        body: formData,
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
      }
      const result = await res.json();
      if (result.tx) {
        const txBuffer = Uint8Array.from(atob(result.tx), c => c.charCodeAt(0));
        const tx = Transaction.from(txBuffer);
        const signed = await window.solana.signAndSendTransaction(tx);
        status.innerText = "íŠ¸ëœì­ì…˜ ì„œëª… ì™„ë£Œ: " + signed.signature;
      } else {
        status.innerText = result.message || "íŠ¸ëœì­ì…˜ ìƒì„± ì‹¤íŒ¨";
      }
    } catch (err) {
      status.innerText = "ğŸš« ì˜¤ë¥˜ ë°œìƒ: " + err.message;
    }
  };

  mintMoreBtn.onclick = async () => {
    const selected = ownedTokens.value;
    const amount = prompt("ì¶”ê°€ ë°œí–‰ ìˆ˜ëŸ‰ì€?");
    const res = await fetch("https://hbb-spl.onrender.com/mint-more", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mint: selected, amount }),
    });
    const result = await res.json();
    status.innerText = result.message || "ì¶”ê°€ ë°œí–‰ ì™„ë£Œ";
  };

  revokeBtn.onclick = async () => {
    const selected = ownedTokens.value;
    const confirmRevoke = confirm("ì •ë§ë¡œ ë¯¼íŒ… ê¶Œí•œì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    if (!confirmRevoke) return;
    const res = await fetch("https://hbb-spl.onrender.com/revoke", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mint: selected }),
    });
    const result = await res.json();
    status.innerText = result.message || "ë¯¼íŒ… ê¶Œí•œ ì œê±° ì™„ë£Œ";
  };

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#eee";
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.style.backgroundColor = "transparent";
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "transparent";
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      imageInput.files = files;
      const reader = new FileReader();
      reader.onload = () => {
        const preview = document.getElementById("preview");
        preview.src = reader.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(files[0]);
    }
  });

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (file) {
      const allowedTypes = ["image/png", "image/jpeg", "image/webp"];
      if (!allowedTypes.includes(file.type)) {
        alert("âŒ ì´ ì´ë¯¸ì§€ í˜•ì‹ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
í—ˆìš©ëœ í˜•ì‹: PNG, JPG, WEBP");
        imageInput.value = "";
        document.getElementById("preview").style.display = "none";
      }
    }
  });
</script>
</body>
</html>
